<html>
<head>
	<title>Notes</title>
	<style>
      .editableText {
        color: blue; /* Standard link color */
        text-decoration: underline; /* Standard link underline */
        cursor: pointer; /* Change mouse cursor to a hand pointer */
        font-size: 1.2em; /* Make it easily visible */
      }
      .editInput, .saveButton {
        padding: 5px;
        margin-left: 10px;
      }
    </style>
	<script src="https://cdn.jsdelivr.net/npm/aws-amplify@4.3.32/dist/aws-amplify.js"></script>
</head>
<body>
<h1>Notes</h1>
<p id="notes"></p>
<div id="noteContainer"></div>
<button id="logoutBtn">Sign Out</button>
<button id="newNote">Create Note</button>
<div id="newNoteCtr"></div>
</body>
<script>
  function updateNoteInDb(userId, noteId, title, content) {
		window.updateURL='https://v5gnr5k7hh.execute-api.us-east-1.amazonaws.com/dev/notes/update'
		
	    const postData = {
			userId: userId,
			noteId: noteId,
			title: title,
			content: content
		};

		fetch(window.updateURL, {
			// 1. Specify the method
			method: 'POST', 
			
			// 2. Set the headers (crucial for sending JSON)
			headers: {
				'Content-Type': 'application/json',
			},
			
			// 3. Convert the JavaScript object to a JSON string for the body
			body: JSON.stringify(postData) 
		})
		.then(response => {
			// Check if the request was successful (status 200-299)
			if (!response.ok) {
				throw new Error(`HTTP error! status: ${response.status}`);
			}
			// Parse the JSON body from the response
			console.log('Success:', response);
			return response.json()
		})
		.then(data => {
			console.log("Parsed response JSON:", data);

			// Now you can access your fields:
			console.log("statusCode:", data.statusCode);
			console.log("body:", data.body);
		})
		.catch(error => {
			// Handle any errors during the fetch or promise chain
			console.error('Error sending POST request:', error);
		});
  }
  // 1. Configure Amplify
  window.onload = async function() {
  aws_amplify.Amplify.configure({
    Auth: {
      region: "us-east-1",
      userPoolId: "us-east-1_gHD8mRDi2",
      userPoolWebClientId: "29ufjq8g5t6k4pts2jjne0diab",
      oauth: {
        domain: "us-east-1ghd8mrdi2.auth.us-east-1.amazoncognito.com",
        scope: ["openid", "email"],
        redirectSignIn: "https://boris-notes-app.s3.us-east-1.amazonaws.com/index.html",
        redirectSignOut: "https://boris-notes-app.s3.us-east-1.amazonaws.com/index.html",
        responseType: "code"
      }
    }
  });
  
  try {
	  const url = new URL(window.location.href);
	  
	  // If Cognito redirected back from login, DO NOT logout
	  if (!url.searchParams.has("code")) {
		  aws_amplify.Amplify.Auth.signOut({ global: false });
		  // Redirect to Cognito Hosted UI logout to clear the session
		  window.location.href =
		  "https://us-east-1ghd8mrdi2.auth.us-east-1.amazoncognito.com/logout" +
		  "?client_id=29ufjq8g5t6k4pts2jjne0diab" +
		  "&redirect_uri=https://boris-notes-app.s3.us-east-1.amazonaws.com/index.html" +
		  "&response_type=code";
		  return;
	  }
	  const user = await aws_amplify.Amplify.Auth.currentAuthenticatedUser();
      window.claims = user.signInUserSession.idToken.payload;

	  console.log("User ID (sub):", window.claims.sub);
      console.log("Email:", window.claims.email);
      console.log("Username:", window.claims["cognito:username"]);
  //console.log("User ID:", user.attributes.sub);
  //console.log("User email:", user.attributes.email);
	  console.log("running js")
	  // Check if we have an ID token already
	  
	  const userAction = async () => {
		console.log("inside function")
		const userName = window.claims["cognito:username"]
		console.log("in main user name is " + userName) 
		const response = await fetch('https://v5gnr5k7hh.execute-api.us-east-1.amazonaws.com/dev/notes?userId=' + userName);
		const myJson = await response.json(); //extract JSON from the http response
		// do something with myJson
		console.log(myJson)
		window.numNotes = 0
		if(myJson.statusCode != 404) {
			const data = JSON.parse(myJson.body)
			window.numNotes = data.length
			for(let i=0; i<data.length; i++) {
				const newParagraph = document.createElement('p');
				newParagraph.setAttribute('id', "notePar"+i)
				const newSpan = document.createElement('span');
				const titleSpan = document.createElement('span');
				const newTitleField = document.createElement("textarea")
				newTitleField.placeholder='Enter note title'
				newTitleField.style.fieldSizing = 'content';
				const newInputField = document.createElement("textarea")
				newInputField.placeholder='Enter note text'
				newInputField.style.fieldSizing = 'content';
				const newSaveButton = document.createElement("button")
				newSaveButton.textContent = "Save"
				newTitleField.style.display = 'none';
				newInputField.style.display = 'none';
				newSaveButton.style.display = 'none';
				titleSpan.addEventListener('click', function() {
					// 1. Set the input field's value to the current text
					newInputField.value = newSpan.textContent;
					newTitleField.value = titleSpan.textContent
					
					// 2. Hide the span and show the input field and button
					newSpan.style.display = 'none';
					titleSpan.style.display = 'none'
					newTitleField.style.display = 'inline-block';
					newInputField.style.display = 'inline-block';
					newSaveButton.style.display = 'inline-block';
					
					// 3. Automatically focus on the input field
					newTitleField.focus();
				});
				newSaveButton.addEventListener('click', function() {
					// 1. Get the new value
					const newText = newInputField.value;
					const newTitleText = newTitleField.value;
					
					// 2. Update the visible text
					titleSpan.textContent = newTitleText + "  "
					newSpan.textContent = newText;
					
					// 3. Hide the input field and button, and show the text span again
					titleSpan.style.display = 'inline';
					newSpan.style.display = 'inline';
					newInputField.style.display = 'none';
					newTitleField.style.display = 'none';
					newSaveButton.style.display = 'none';

					// NOTE: If you were connecting to a database, the save logic goes here!
					updateNoteInDb(data[i].userId, data[i].noteId, newTitleText, newText)
				});
				newSpan.setAttribute('id', "noteSpan"+i)
				newSpan.textContent = data[i].content
				title=""
				if(data[i].title) {
					title = data[i].title
				}
				else {
					title = "Text note " + data[i].updated_ts.substring(0,10)
				}
				titleSpan.textContent = title + "  "
				titleSpan.classList.add("editableText")
				newParagraph.appendChild(titleSpan);
				newParagraph.appendChild(newSpan);
				newInputField.classList.add("editInput");
				newSaveButton.classList.add("saveButton");
				newParagraph.appendChild(newTitleField);
				newParagraph.appendChild(newInputField);
				newParagraph.appendChild(newSaveButton);
				document.getElementById("noteContainer").appendChild(newParagraph)
			}
		  }
	  }
	  userAction()
	  } catch (err) {
		  aws_amplify.Amplify.Auth.federatedSignIn(); // redirects to Hosted UI
	  }
}
</script>
<script>
  const logoutBtn = document.getElementById("logoutBtn");
  logoutBtn.addEventListener("click", async () => {
  console.log("log out is pressed")
  try {
    // Clear Amplify session locally
    await aws_amplify.Auth.signOut({ global: false }); // local only, avoids the NotAuthorizedException

    // Redirect to Cognito Hosted UI logout to clear the session
    window.location.href =
      "https://us-east-1ghd8mrdi2.auth.us-east-1.amazoncognito.com/logout" +
      "?client_id=29ufjq8g5t6k4pts2jjne0diab" +
      "&logout_uri=https://boris-notes-app.s3.us-east-1.amazonaws.com/index.html";

  } catch (err) {
    console.error("Error signing out:", err);
  }
});
</script>
<script>
	const newNoteBtn = document.getElementById("newNote");
	console.log("obtained new note btn")
	const newNoteField = document.createElement("textarea")
	newNoteField.style.fieldSizing = 'content';
	newNoteField.placeholder='Enter note text'
	const newNoteTitle = document.createElement("textarea")
	newNoteTitle.style.fieldSizing = 'content';
	newNoteTitle.placeholder='Enter note title'
	const newNoteSaveButton = document.createElement("button")
	newNoteSaveButton.textContent = "Save"
	newNoteSaveButton.style.display = 'none';
	newNoteField.style.display = "none"
	newNoteTitle.style.display = "none"
	const newNoteCtr = document.getElementById("newNoteCtr")
	newNoteCtr.appendChild(newNoteTitle)
	newNoteCtr.appendChild(newNoteField)
	newNoteCtr.appendChild(newNoteSaveButton)
	newNoteBtn.addEventListener("click", async () => {
		console.log("new note button is pressed")
		try {
			newNoteSaveButton.style.display = 'inline';
			newNoteTitle.style.display = "inline"
			newNoteField.style.display = "inline"
		}
		catch (err) {
			console.error("Error creating new note: ", err);
		}	
	})
	newNoteSaveButton.addEventListener("click", async () => {
		console.log("save new note is pressed")
		let newNoteId
		try {
			newTitle = newNoteTitle.value
			if(!newTitle) {
				newTitle = "Text note " + (new Date()).toISOString().substring(0,10)
			}
			// save the note into the database 
			const apiUrl = 'https://v5gnr5k7hh.execute-api.us-east-1.amazonaws.com/dev/notes/insert';
			const postData = {
				userId: window.claims["cognito:username"],
				title: newTitle,
				content: newNoteField.value
			};

			fetch(apiUrl, {
				// 1. Specify the method
				method: 'POST', 
				
				// 2. Set the headers (crucial for sending JSON)
				headers: {
					'Content-Type': 'application/json',
				},
				
				// 3. Convert the JavaScript object to a JSON string for the body
				body: JSON.stringify(postData) 
			})
			.then(response => {
				// Check if the request was successful (status 200-299)
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				// Parse the JSON body from the response
				console.log('Success:', response);
				return response.json()
			})
			.then(data => {
				console.log("Parsed response JSON:", data);

				// Now you can access your fields:
				console.log("statusCode:", data.statusCode);
				console.log("body:", data.body);
				newNoteId = data.body.noteId
			})
			.catch(error => {
				// Handle any errors during the fetch or promise chain
				console.error('Error sending POST request:', error);
			});
			newNoteSaveButton.style.display = 'none';
			newNoteTitle.style.display = "none"
			newNoteField.style.display = "none"
			newNoteTitle.style.fieldSizing = 'content';
			newNoteField.style.fieldSizing = 'content';
			newNoteTitle.placeholder='Enter note title'
			newNoteField.placeholder='Enter note text'
			const notesDiv = document.getElementById("noteContainer");
			const newParagraph = document.createElement('p');
			newParagraph.setAttribute('id', "notePar"+(window.numNotes + 1))
			const newTitleSpan = document.createElement('span');
			newTitleSpan.textContent = newTitle + "  "
			const newSpan = document.createElement('span');
			newSpan.textContent = newNoteField.value
			newNoteField.value = ""
			newNoteTitle.value = ""
			console.log("new span text content is " + newSpan.textContent)
			newSpan.setAttribute('id', "noteSpan"+(window.numNotes + 1))
			const newInputTitle = document.createElement("textarea")
			newInputTitle.style.fieldSizing = 'content';
			const newInputField = document.createElement("textarea")
			newInputField.style.fieldSizing = 'content';
			const newSaveButton = document.createElement("button")
			newSaveButton.textContent = "Save"
			newInputField.style.display = 'none';
			newInputTitle.style.display = 'none';
			newSaveButton.style.display = 'none';
			newTitleSpan.classList.add("editableText")
			newParagraph.appendChild(newTitleSpan);
			newParagraph.appendChild(newSpan);
			window.numNotes = window.numNotes + 1
			newInputField.classList.add("editInput");
			newSaveButton.classList.add("saveButton");
			newParagraph.appendChild(newInputTitle)
			newParagraph.appendChild(newInputField);
			newParagraph.appendChild(newSaveButton);
			notesDiv.appendChild(newParagraph)
			
			newTitleSpan.addEventListener('click', function() {
				// 1. Set the input field's value to the current text
				newInputField.value = newSpan.textContent;
				newInputTitle.value = newTitleSpan.textContent
				// 2. Hide the span and show the input field and button
				newTitleSpan.style.display = 'none'
				newSpan.style.display = 'none';
				newInputField.style.display = 'inline-block';
				newInputTitle.style.display = 'inline-block';
				newSaveButton.style.display = 'inline-block';
				
				// 3. Automatically focus on the input field
				newInputTitle.focus();
			});
			newSaveButton.addEventListener('click', function() {
				// 1. Get the new value
				const newText = newInputField.value;
				const newTitleText = newInputTitle.value;
				
				// 2. Update the visible text
				if(newTitleText) {
					newTitleSpan.textContent = newTitleText
				}
				else {
					newTitleSpan.textContent = "Text note " + (new Date()).toISOString().substring(0,10)
				}
				newSpan.textContent = newText;
				updateNoteInDb(window.claims["cognito:username"], newNoteId, newTitleText, newText)
				
				// 3. Hide the input field and button, and show the text span again
				newSpan.style.display = 'inline';
				newTitleSpan.style.display = 'inline';
				newInputTitle.style.display = 'none';
				newInputField.style.display = 'none';
				newSaveButton.style.display = 'none';
			})
		}
		catch (err) {
			console.error("Error saving new note: ", err);
		}
	})
</script>
</html>